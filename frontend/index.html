<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;padding-top:40px}.container{background-color:#fff;padding:30px 40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08);width:100%;max-width:500px;text-align:center;box-sizing:border-box}h1,h2{color:#2c3e50}input[type=text],input[type=email]{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px}.reg-id-container{display:flex;margin-bottom:20px}.reg-id-container input{flex-grow:1;margin-bottom:0;border-top-right-radius:0;border-bottom-right-radius:0}.reg-id-container button{border-top-left-radius:0;border-bottom-left-radius:0;border-left:0}button{background-color:#3498db;color:#fff;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:700;width:100%;transition:background-color .3s ease}button:hover{background-color:#2980b9}#message{margin-top:15px;font-weight:700}.hidden{display:none}#qr-code-container{margin-top:20px}#qrcode{margin:20px auto;padding:10px;background:#fff;display:inline-block;border:1px solid #eee}#download-qr{display:block;margin:10px auto;background-color:#2ecc71;color:#fff;padding:10px 15px;border-radius:8px;text-decoration:none;max-width:200px}#download-qr:hover{background-color:#27ae60}.nav-links{margin-top:30px;border-top:1px solid #eee;padding-top:20px;display:flex;justify-content:space-around}.nav-links a{text-decoration:none;color:#3498db;font-weight:500}.nav-links a:hover{text-decoration:underline}
    </style>
</head>
<body>
    <div class="container">
        <h1>Event Registration</h1>
        <div id="registration-form-container">
            <form id="registration-form">
                <input type="text" id="name" placeholder="Full Name" required>
                <input type="email" id="email" placeholder="Email Address" required>
                <div class="reg-id-container">
                    <input type="text" id="registration-id" placeholder="Unique Registration ID" required readonly>
                    <button type="button" id="generate-id-btn">Generate</button>
                </div>
                <button type="submit">Register</button>
            </form>
            <p id="message"></p>
        </div>
        
        <div id="qr-code-container" class="hidden">
            <h2>Your Registration is Complete!</h2>
            <p>Please save this QR code for check-in.</p>
            <div id="qrcode"></div>
            <a id="download-qr" download="event-qr-code.png">Download QR Code</a>
            <button onclick="window.location.reload()">Register Another</button>
        </div>
        
        <div class="nav-links">
            <a href="/scanner.html">Go to Scanner</a>
            <a href="/admin.html">Go to Admin Dashboard</a>
        </div>
    </div>

    <!-- ✅ FIX: Use browser-friendly qrcodejs instead of Node build -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registration-form');
            const messageEl = document.getElementById('message');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const formContainer = document.getElementById('registration-form-container');
            const registrationIdInput = document.getElementById('registration-id');
            const generateIdBtn = document.getElementById('generate-id-btn');
            const downloadLink = document.getElementById('download-qr');
            const qrCodeDiv = document.getElementById('qrcode');

            const generateId = () => {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substring(2, 8);
                registrationIdInput.value = `EVT-${timestamp}-${randomStr}`.toUpperCase();
            };

            generateIdBtn.addEventListener('click', generateId);
            generateId(); // Generate ID on page load

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const registration_id = registrationIdInput.value;
                
                messageEl.textContent = '';
                messageEl.classList.remove('error', 'success');

                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, registration_id }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        formContainer.classList.add('hidden');
                        qrCodeContainer.classList.remove('hidden');

                        // ✅ FIX: Generate QR with qrcodejs
                        qrCodeDiv.innerHTML = "";
                        new QRCode(qrCodeDiv, {
                            text: registration_id,
                            width: 200,
                            height: 200
                        });

                        // ✅ update download link
                        setTimeout(() => {
                            const img = qrCodeDiv.querySelector("img");
                            if (img) {
                                downloadLink.href = img.src;
                            }
                        }, 500);

                    } else {
                        messageEl.textContent = 'Error: ' + result.error;
                        messageEl.classList.add('error');
                    }
                } catch (error) {
                    messageEl.textContent = 'A network error occurred. Please try again.';
                    messageEl.classList.add('error');
                }
            });
        });
    </script>
</body>
</html>
