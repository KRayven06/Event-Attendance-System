<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Registration</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #1a1a1a;
        color: #f8f9fa;
      }
      .container {
        max-width: 500px;
        margin-top: 50px;
      }
      .card {
        background-color: #2c2c2c;
        border: 1px solid #444;
      }
      .form-control,
      .form-control:focus {
        background-color: #3a3a3a;
        color: #f8f9fa;
        border-color: #555;
      }
      .form-control::placeholder {
        color: #aaa;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
      }
      .logo {
        width: 40px;
        height: 40px;
      }
      #qrcode {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
      }
      .nav-button {
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #3a3a3a;
        color: #f8f9fa;
        transition: background-color 0.2s ease-in-out;
      }
      .nav-button:hover {
        background-color: #4a4a4a;
        color: #fff;
      }
      .nav-button svg {
        margin-right: 0.75rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card shadow-lg">
        <div class="card-body p-4 p-md-5">
          <div class="text-center mb-4">
            <svg
              class="logo"
              viewBox="0 0 100 100"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill="#007bff"
                d="M50 0L95.1 24.4V75.6L50 100L4.9 75.6V24.4L50 0Z"
              />
              <path
                fill="#fff"
                d="M50 15L82.5 32.7V67.3L50 85L17.5 67.3V32.7L50 15ZM50 22.5L25.9 36.1V63.9L50 77.5L74.1 63.9V36.1L50 22.5Z"
              />
            </svg>
            <h1 class="h3 fw-bold mt-2 mb-0">Event Registration</h1>
          </div>

          <div id="registration-form-container">
            <form id="registration-form">
              <div class="mb-3">
                <input
                  type="text"
                  id="name"
                  class="form-control"
                  placeholder="Full Name"
                  required
                />
              </div>
              <div class="mb-3">
                <input
                  type="email"
                  id="email"
                  class="form-control"
                  placeholder="Email Address"
                  required
                />
              </div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="registration-id"
                  class="form-control"
                  placeholder="Unique Registration ID"
                  required
                  readonly
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="generate-id-btn"
                >
                  Generate
                </button>
              </div>
              <button type="submit" class="btn btn-primary w-100 py-2">
                Register
              </button>
            </form>
            <p id="message" class="mt-3 text-center"></p>
          </div>

          <div id="qr-code-container" class="text-center d-none">
            <h2 class="h4 mb-3">Registration Complete!</h2>
            <p class="text-muted">Save this QR code for check-in.</p>
            <div id="qrcode" class="d-inline-block mb-3"></div>
            <a
              id="download-qr"
              class="btn btn-success w-100 mb-2"
              download="event-qr-code.png"
              >Download QR Code</a
            >
            <button
              class="btn btn-secondary w-100"
              onclick="window.location.reload()"
            >
              Register Another
            </button>
          </div>

          <hr class="my-4" />

          <div class="row g-3">
            <div class="col-6">
              <a href="/scanner.html" class="nav-button">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M3 7V5a2 2 0 0 1 2-2h2" />
                  <path d="M17 3h2a2 2 0 0 1 2 2v2" />
                  <path d="M21 17v2a2 2 0 0 1-2 2h-2" />
                  <path d="M7 21H5a2 2 0 0 1-2-2v-2" />
                  <path d="M7 12h10" />
                </svg>
                <span>Scan QR</span>
              </a>
            </div>
            <div class="col-6">
              <a href="/admin.html" class="nav-button">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                </svg>
                <span>Admin Panel</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("registration-form");
        const messageEl = document.getElementById("message");
        const qrCodeContainer = document.getElementById("qr-code-container");
        const formContainer = document.getElementById(
          "registration-form-container"
        );
        const registrationIdInput = document.getElementById("registration-id");
        const generateIdBtn = document.getElementById("generate-id-btn");
        const downloadLink = document.getElementById("download-qr");
        const qrCodeDiv = document.getElementById("qrcode");

        const generateId = () => {
          const timestamp = Date.now().toString(36);
          const randomStr = Math.random().toString(36).substring(2, 8);
          registrationIdInput.value =
            `EVT-${timestamp}-${randomStr}`.toUpperCase();
        };

        generateIdBtn.addEventListener("click", generateId);
        generateId();

        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const name = document.getElementById("name").value;
          const email = document.getElementById("email").value;
          const registration_id = registrationIdInput.value;

          messageEl.textContent = "";
          messageEl.classList.remove("text-danger", "text-success");

          try {
            const response = await fetch("/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email, registration_id }),
            });

            const result = await response.json();

            if (response.ok) {
              formContainer.classList.add("d-none");
              qrCodeContainer.classList.remove("d-none");

              qrCodeDiv.innerHTML = "";
              new QRCode(qrCodeDiv, {
                text: registration_id,
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.H,
              });

              setTimeout(() => {
                const img = qrCodeDiv.querySelector("img");
                if (img) {
                  downloadLink.href = img.src;
                }
              }, 500);
            } else {
              messageEl.textContent = "Error: " + result.error;
              messageEl.classList.add("text-danger");
            }
          } catch (error) {
            messageEl.textContent =
              "A network error occurred. Please try again.";
            messageEl.classList.add("text-danger");
          }
        });
      });
    </script>
  </body>
</html>
